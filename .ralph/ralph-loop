#!/bin/bash

# Ralph Loop - Dashboard Compatible
# Includes subprocess fixes for claude CLI

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Navigate to project root
cd "$(dirname "$0")/.."

PROJECT_ROOT=$(pwd)
PROJECT_NAME="socialMediaAI-web-ui"

# Create logs directory
mkdir -p .ralph/logs

# Log file with timestamp
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE=".ralph/logs/ralph_${TIMESTAMP}.log"

# Detect timeout command (gtimeout on macOS, timeout on Linux)
if command -v gtimeout &> /dev/null; then
  TIMEOUT_CMD="gtimeout"
elif command -v timeout &> /dev/null; then
  TIMEOUT_CMD="timeout"
else
  echo -e "${RED}❌ Error: Neither gtimeout nor timeout command found${NC}"
  echo "Install coreutils: brew install coreutils"
  exit 1
fi

# Max runtime: 8 hours
MAX_RUNTIME=28800

# Environment for token efficiency
export MAX_THINKING_TOKENS=5000
export CLAUDE_AUTOCOMPACT_PCT_OVERRIDE=50

echo -e "${GREEN}╔════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║     🚀 Ralph Loop - Social Chef UI        ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${BLUE}📋 Project:${NC} $PROJECT_NAME"
echo -e "${BLUE}📁 Root:${NC} $PROJECT_ROOT"
echo -e "${BLUE}📝 Log:${NC} $LOG_FILE"
echo -e "${BLUE}⏰ Start:${NC} $(date)"
echo ""

# Function to send notification (if webhook configured)
send_notification() {
  local title="$1"
  local message="$2"
  local color="$3"

  if [ -n "$DISCORD_WEBHOOK_URL" ]; then
    curl -s -X POST "$DISCORD_WEBHOOK_URL" \
      -H "Content-Type: application/json" \
      -d "{
        \"content\": \"$title\",
        \"embeds\": [{
          \"description\": \"$message\",
          \"color\": $color,
          \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
        }]
      }" > /dev/null 2>&1
  fi
}

send_notification "🚀 **Ralph Loop Started**" "Project: $PROJECT_NAME" 3447003

# Launch Claude Code with orchestrator
echo -e "${GREEN}🤖 Launching orchestrator...${NC}"
echo ""

cd "$PROJECT_ROOT"

# Create orchestrator prompt if not exists
if [ ! -f ".ralph/ORCHESTRATOR_GENERIC.md" ]; then
  cat > .ralph/ORCHESTRATOR_GENERIC.md <<'EOF'
# Ralph Orchestrator - Task Automation

You are an autonomous development agent working on tasks for this project.

## Your Mission

Process tasks from the TODO list in `.ralph/tasks.md`:
1. Read the tasks from the TODO section
2. Work through them systematically
3. Move completed tasks to COMPLETED section
4. Create detailed commit messages for each change
5. When all TODO tasks are done, exit cleanly

## Task Format

Tasks are in `.ralph/tasks.md` with this structure:

```markdown
## 📋 TODO

- [ ] [TASK-1] Task description
- [ ] [TASK-2] Another task

## ✅ COMPLETED

- [x] [TASK-0] Previously completed task
```

## Working Process

1. Read `.ralph/tasks.md` to see current TODO list
2. Pick the first uncompleted task
3. Complete the task with high quality code
4. Move the task to COMPLETED section
5. Commit your changes
6. Repeat until TODO is empty
7. When done, say "ALL TASKS COMPLETE" and exit

## Rules

- Work autonomously without asking for permission
- Write clean, production-quality code
- Test your changes when appropriate
- Commit frequently with clear messages
- Focus on one task at a time
- Be thorough but efficient

Good luck!
EOF
fi

# Read the orchestrator prompt
PROMPT="$(cat .ralph/ORCHESTRATOR_GENERIC.md)"

# KEY SUBPROCESS FIXES:
# --print: Non-interactive mode (essential for subprocess execution)
# --dangerously-skip-permissions: Bypass all permission checks
# --no-session-persistence: Don't save session (faster, cleaner)
set +e  # Don't exit on error, capture the exit code

(
  $TIMEOUT_CMD ${MAX_RUNTIME}s claude \
    --print \
    --dangerously-skip-permissions \
    --no-session-persistence \
    "$PROMPT" 2>&1
) | tee "$LOG_FILE"

# Capture exit code from the subshell (first command in pipe)
EXIT_CODE=${PIPESTATUS[0]}

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║          🏁 Ralph Loop Finished           ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${BLUE}⏰ End:${NC} $(date)"
echo -e "${BLUE}📊 Exit Code:${NC} $EXIT_CODE"
echo -e "${BLUE}📖 Log:${NC} $LOG_FILE"
echo ""

# Send completion notification
send_notification "🏁 **Ralph Loop Finished**" "Exit Code: $EXIT_CODE" 5763719

exit $EXIT_CODE
